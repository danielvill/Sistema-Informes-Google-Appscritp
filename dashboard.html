<style>
    .vista-estadisticas {
        display: none;
    }

    .vista-reportes {
        display: block;
    }

    .filtros-estadisticas {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    h2 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 5px;
        margin-top: 40px;
    }

    table.dataTable thead {
        background-color: #3498db;
        color: white;
    }

    th,
    td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #3498db;
        color: white;
    }

    tr:nth-child(even) {
        background-color: #ecf0f1;
    }
</style>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-center">Resumen Mensual</h1>
        <div>
            <button id="btnChart" class="btn btn-outline-primary me-2">
                游늵 Ver estad칤sticas
            </button>
            <button id="btnReportes" class="btn btn-outline-secondary" style="display: none;">
                游늯 Ver reportes
            </button>
        </div>
    </div>

    <!-- Vista de Reportes (original) -->
    <div id="vistaReportes" class="vista-reportes">
        <h2 id="tituloMes" class="text-center mb-3"></h2>
        <div id="reporte" class="fs-5"></div>
        <br><br>
        <h1 class="text-center mb-4">Resumen Anual</h1>
        <div id="reporte2"></div>
    </div>

    <!-- Vista de Estad칤sticas -->
    <div id="vistaEstadisticas" class="vista-estadisticas">
        <h2 class="text-center mb-4">游늵 Estad칤sticas</h2>

        <!-- Filtros de A침o y Mes -->
        <div class="filtros-estadisticas">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Seleccionar A침o:</label>
                    <select id="selectAno" class="form-select">
                        <option value="">Cargando a침os...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Seleccionar Mes:</label>
                    <select id="selectMes" class="form-select">
                        <option value="">Cargando meses...</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="btnActualizar" class="btn btn-primary w-100">
                        游댃 Actualizar Estad칤sticas
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">游늳 Participaci칩n Mensual</h5>
                        <p class="text-muted small">A침o seleccionado: <span id="anoParticipacion">-</span></p>
                        <canvas id="chartParticipacion"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">游닄 Total de cursos b칤blicos por Grupo</h5>
                        <p class="text-muted small">Per칤odo: <span id="periodoCursos">-</span></p>
                        <canvas id="chartCursos"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">游논 Hermanos con cursos b칤blicos por Grupo</h5>
                        <p class="text-muted small">Per칤odo: <span id="periodoPersonas">-</span></p>
                        <canvas id="chartPersonasCursos"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">游늵 Resumen por Tipo</h5>
                <p class="text-muted small">Per칤odo: <span id="periodoTipos">-</span></p>
                <div id="tablaTipos"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let chartParticipacion = null;
    let chartCursos = null;
    let datosCompletos = {
        cursosPorGrupo: {},
        participacion: [],
        resumenPorTipo: {}
    };

    // Funci칩n para cambiar entre vistas
    function mostrarEstadisticas() {
        document.getElementById('vistaReportes').style.display = 'none';
        document.getElementById('vistaEstadisticas').style.display = 'block';
        document.getElementById('btnChart').style.display = 'none';
        document.getElementById('btnReportes').style.display = 'inline-block';
        cargarFiltros();
    }

    function mostrarReportes() {
        document.getElementById('vistaEstadisticas').style.display = 'none';
        document.getElementById('vistaReportes').style.display = 'block';
        document.getElementById('btnReportes').style.display = 'none';
        document.getElementById('btnChart').style.display = 'inline-block';
    }

    // Event listeners para los botones
    document.getElementById("btnChart").addEventListener("click", mostrarEstadisticas);
    document.getElementById("btnReportes").addEventListener("click", mostrarReportes);
    document.getElementById("btnActualizar").addEventListener("click", actualizarEstadisticas);

    // Cargar filtros de a침os y meses
    function cargarFiltros() {
        // Personas con cursos por grupo
        google.script.run.withSuccessHandler(function (data) {
            datosCompletos.personasConCursos = data; // 游녣 nuevo objeto
            poblarSelectores();
        }).getPersonasConCursosPorGrupo();

        // Cursos por grupo (suma de cursos)
        google.script.run.withSuccessHandler(function (data) {
            datosCompletos.cursosPorGrupo = data;
        }).getCursosPorGrupo();

        // Participaci칩n
        google.script.run.withSuccessHandler(function (data) {
            datosCompletos.participacion = data;
        }).getParticipacionPorMes();

        // Resumen por tipo
        google.script.run.withSuccessHandler(function (data) {
            datosCompletos.resumenPorTipo = data;
        }).getResumenPorTipo();
    }

    function poblarSelectores() {
        const periodos = Object.keys(datosCompletos.cursosPorGrupo);
        const anos = new Set();
        const meses = new Set();

        periodos.forEach(periodo => {
            const [mes, ano] = periodo.split('-');
            anos.add(ano);
            meses.add(mes);
        });

        // Poblar select de a침os
        const selectAno = document.getElementById('selectAno');
        selectAno.innerHTML = '<option value="">Todos los a침os</option>';
        Array.from(anos).sort().forEach(ano => {
            selectAno.innerHTML += `<option value="${ano}">${ano}</option>`;
        });

        // Poblar select de meses
        const selectMes = document.getElementById('selectMes');
        const mesesOrden = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        selectMes.innerHTML = '<option value="">Todos los meses</option>';
        mesesOrden.forEach(mes => {
            if (meses.has(mes)) {
                selectMes.innerHTML += `<option value="${mes}">${mes}</option>`;
            }
        });

        // Seleccionar el per칤odo m치s reciente por defecto
        if (periodos.length > 0) {
            const ultimoPeriodo = periodos[periodos.length - 1];
            const [ultimoMes, ultimoAno] = ultimoPeriodo.split('-');
            selectAno.value = ultimoAno;
            selectMes.value = ultimoMes;
            actualizarEstadisticas();
        }
    }

    function actualizarEstadisticas() {
        const ano = document.getElementById('selectAno').value;
        const mes = document.getElementById('selectMes').value;

        // Actualizar gr치fico de cursos por grupo
        actualizarGraficoCursos(ano, mes);

        // Actualizar gr치fico de participaci칩n
        actualizarGraficoParticipacion(ano);

        // Actualizar tabla de resumen por tipo
        actualizarTablaTipos(ano, mes);

        actualizarGraficoPersonasCursos(ano, mes); // 游녣 aqu칤
    }

    function actualizarGraficoCursos(ano, mes) {
        let periodo = '';
        if (mes && ano) {
            periodo = `${mes}-${ano}`;
        } else if (ano) {
            // Buscar el primer mes disponible del a침o
            const periodosAno = Object.keys(datosCompletos.cursosPorGrupo).filter(p => p.endsWith(ano));
            periodo = periodosAno[0] || '';
        } else if (mes) {
            // Buscar el primer a침o disponible del mes
            const periodosMes = Object.keys(datosCompletos.cursosPorGrupo).filter(p => p.startsWith(mes));
            periodo = periodosMes[0] || '';
        } else {
            // Tomar el 칰ltimo per칤odo disponible
            const periodos = Object.keys(datosCompletos.cursosPorGrupo);
            periodo = periodos[periodos.length - 1] || '';
        }

        document.getElementById('periodoCursos').innerText = periodo || 'Sin datos';

        if (!periodo || !datosCompletos.cursosPorGrupo[periodo]) {
            if (chartCursos) chartCursos.destroy();
            return;
        }

        const grupos = Object.keys(datosCompletos.cursosPorGrupo[periodo]);
        const valores = Object.values(datosCompletos.cursosPorGrupo[periodo]);

        const ctx = document.getElementById("chartCursos");

        if (chartCursos) {
            chartCursos.destroy();
        }

        chartCursos = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: grupos,
                datasets: [{
                    data: valores,
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#fd7e14']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ${value} ${value !== 1 ? '' : ''}  cursos b칤blicos`;
                            }
                        }
                    }
                }
            }
        });
    }



    // Esta es para los grupo 
    let chartPersonasCursos = null;

    function actualizarGraficoPersonasCursos(ano, mes) {
        let periodo = '';
        if (mes && ano) {
            periodo = `${mes}-${ano}`;
        } else {
            const periodos = Object.keys(datosCompletos.personasConCursos);
            periodo = periodos[periodos.length - 1] || '';
        }

        document.getElementById('periodoPersonas').innerText = periodo || 'Sin datos';

        if (!periodo || !datosCompletos.personasConCursos[periodo]) {
            if (chartPersonasCursos) chartPersonasCursos.destroy();
            return;
        }

        const grupos = Object.keys(datosCompletos.personasConCursos[periodo]);
        const valores = Object.values(datosCompletos.personasConCursos[periodo]);

        const ctx = document.getElementById("chartPersonasCursos");

        if (chartPersonasCursos) chartPersonasCursos.destroy();

        chartPersonasCursos = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: grupos,
                datasets: [{
                    label: "Personas con cursos",
                    data: valores,
                    backgroundColor: "#17a2b8"
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }



    function actualizarGraficoParticipacion(ano) {
        let datosFiltrados = datosCompletos.participacion;

        if (ano) {
            datosFiltrados = datosCompletos.participacion.filter(r => r.a침o == ano);
        }

        document.getElementById('anoParticipacion').innerText = ano || 'Todos';

        const labels = datosFiltrados.map(r => r.mes + " " + r.a침o);
        const si = datosFiltrados.map(r => r.si);
        const no = datosFiltrados.map(r => r.no);

        const ctx = document.getElementById("chartParticipacion");

        if (chartParticipacion) {
            chartParticipacion.destroy();
        }

        chartParticipacion = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "S칤 participaron",
                        data: si,
                        backgroundColor: "#28a745"
                    },
                    {
                        label: "No participaron",
                        data: no,
                        backgroundColor: "#dc3545"
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function actualizarTablaTipos(ano, mes) {
        let periodo = '';
        if (mes && ano) {
            periodo = `${mes}-${ano}`;
        }

        document.getElementById('periodoTipos').innerText = periodo || 'Todos los per칤odos';

        let html = "";

        if (periodo && datosCompletos.resumenPorTipo[periodo]) {
            // Mostrar solo el per칤odo seleccionado
            html += `<h5 class="mt-3">${periodo}</h5>
                         <table class="table table-bordered table-striped">
                         <thead class="table-dark">
                         <tr><th>Tipo</th><th>Cantidad</th><th>Horas</th><th>Cursos</th></tr>
                         </thead><tbody>`;
            Object.keys(datosCompletos.resumenPorTipo[periodo]).forEach(tipo => {
                const t = datosCompletos.resumenPorTipo[periodo][tipo];
                html += `<tr><td>${tipo}</td><td>${t.cantidad}</td><td>${t.horas}</td><td>${t.cursos}</td></tr>`;
            });
            html += "</tbody></table>";
        } else if (ano) {
            // Mostrar todos los per칤odos del a침o seleccionado
            Object.keys(datosCompletos.resumenPorTipo)
                .filter(p => p.endsWith(ano))
                .forEach(periodo => {
                    html += `<h5 class="mt-3">${periodo}</h5>
                                 <table class="table table-bordered table-striped">
                                 <thead class="table-dark">
                                 <tr><th>Tipo</th><th>Cantidad</th><th>Horas</th><th>Cursos</th></tr>
                                 </thead><tbody>`;
                    Object.keys(datosCompletos.resumenPorTipo[periodo]).forEach(tipo => {
                        const t = datosCompletos.resumenPorTipo[periodo][tipo];
                        html += `<tr><td>${tipo}</td><td>${t.cantidad}</td><td>${t.horas}</td><td>${t.cursos}</td></tr>`;
                    });
                    html += "</tbody></table>";
                });
        } else {
            // Mostrar todos los per칤odos
            Object.keys(datosCompletos.resumenPorTipo).forEach(periodo => {
                html += `<h5 class="mt-3">${periodo}</h5>
                             <table class="table table-bordered table-striped">
                             <thead class="table-dark">
                             <tr><th>Tipo</th><th>Cantidad</th><th>Horas</th><th>Cursos</th></tr>
                             </thead><tbody>`;
                Object.keys(datosCompletos.resumenPorTipo[periodo]).forEach(tipo => {
                    const t = datosCompletos.resumenPorTipo[periodo][tipo];
                    html += `<tr><td>${tipo}</td><td>${t.cantidad}</td><td>${t.horas}</td><td>${t.cursos}</td></tr>`;
                });
                html += "</tbody></table>";
            });
        }

        document.getElementById("tablaTipos").innerHTML = html || '<p class="text-muted">No hay datos disponibles para el per칤odo seleccionado.</p>';
    }

    // ========== REPORTES ORIGINALES ==========

    // C칩digo de resumen de los informes mensuales
    google.script.run.withSuccessHandler(renderReporte).getReporteData();

    function renderReporte(data) {
        document.getElementById("tituloMes").innerText = data.mes + " " + data.a침o;
        let html = `
                <p><strong style="color:#6f4e37;">&#128100; Publicadores</strong><br>
                Cantidad: ${data.tipos.Publicador.cantidad}<br>
                Horas: ${data.tipos.Publicador.horas}<br>
                Cursos: ${data.tipos.Publicador.cursos}</p>
                
                <p><strong style="color:#1E90FF;">&#128188; Regulares</strong><br>
                Cantidad: ${data.tipos.Regular.cantidad}<br>
                Horas: ${data.tipos.Regular.horas}<br>
                Cursos: ${data.tipos.Regular.cursos}</p>
                
                <p><strong style="color:#228B22;">&#128101;+ Auxiliares</strong><br>
                Cantidad: ${data.tipos.Auxiliar.cantidad}<br>
                Horas: ${data.tipos.Auxiliar.horas}<br>
                Cursos: ${data.tipos.Auxiliar.cursos}</p>
                
                <hr>
                <p><strong style="color:#DAA520;">Total de los que S칈 participaron:</strong> <span style="color:#000;">${data.totalSi}</span></p>
                <p><strong style="color:#A52A2A;">Total de los que NO participaron:</strong> <span style="color:#000;">${data.totalNo}</span></p>
            `;
        document.getElementById("reporte").innerHTML = html;
    }

    // Crear tabla con ID 칰nica para DataTables
    function crearTabla(titulo, encabezados, filas, id) {
        let html = `<h3>${titulo}</h3><table id="${id}" class="display table table-striped"><thead><tr>`;
        encabezados.forEach(enc => html += `<th>${enc}</th>`);
        html += `</tr></thead><tbody>`;
        filas.forEach(fila => {
            html += `<tr>`;
            encabezados.forEach(enc => html += `<td>${fila[enc]}</td>`);
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        return html;
    }

    google.script.run.withSuccessHandler(function (reporte) {
        let html = "";
        let tablaIndex = 0;

        Object.keys(reporte).forEach(a침o => {
            html += `<h2 class="mt-4">游늰 Reporte del a침o ${a침o}</h2>`;

            // Tabla de personas sin cursos b칤blicos
            const sinCursos = reporte[a침o].sinCursos.map(p => ({
                "Nombre": p.nombre,
                "Tipo": p.tipo,
                "Mes": p.mes,
                "Grupo": p.grupo
            }));
            html += crearTabla("Personas sin cursos b칤blicos", ["Nombre", "Tipo", "Mes", "Grupo"], sinCursos, `tabla${tablaIndex++}`);

            // Tabla de horas por tipo Regular
            const horas = Object.entries(reporte[a침o].horasRegulares).map(([nombre, info]) => ({
                "Nombre": nombre,
                "Tipo": info.tipo,
                "Grupo": info.grupo,
                "Horas": info.horas
            }));
            html += crearTabla("Resumen de horas por tipo Regular", ["Nombre", "Tipo", "Grupo", "Horas"], horas, `tabla${tablaIndex++}`);
        });

        document.getElementById("reporte2").innerHTML = html;

        // Inicializar DataTables despu칠s de insertar las tablas
        setTimeout(() => {
            for (let i = 0; i < tablaIndex; i++) {
                $(`#tabla${i}`).DataTable({
                    pageLength: 10,
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                    }
                });
            }
        }, 100);
    }).getReportePorAnio();
</script>